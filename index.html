<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>Corner City Gent 点单打印</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
      "Helvetica Neue", Arial, "Microsoft YaHei", sans-serif;
    margin: 8px;
    font-size: 15px;
  }
  h1 {
    font-size: 22px;
    margin: 4px 0 8px;
  }
  h2 {
    font-size: 18px;
    margin: 10px 0 6px;
  }
  .section {
    border: 1px solid #ccc;
    padding: 8px;
    margin-bottom: 10px;
    border-radius: 4px;
  }
  textarea {
    width: 100%;
    box-sizing: border-box;
    min-height: 80px;
    font-size: 14px;
  }
  input[type="text"], input[type="number"] {
    padding: 4px 6px;
    font-size: 15px;
    width: 90px;
    box-sizing: border-box;
  }
  button {
    padding: 6px 10px;
    margin: 4px 4px 4px 0;
    font-size: 14px;
    border-radius: 3px;
    border: 1px solid #888;
    background: #f5f5f5;
  }
  button.primary {
    background: #1e88e5;
    color: #fff;
    border-color: #1e88e5;
  }
  button.danger {
    background: #e53935;
    color: #fff;
    border-color: #e53935;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 14px;
  }
  th, td {
    border: 1px solid #ddd;
    padding: 4px;
    text-align: center;
  }
  th {
    background: #f0f0f0;
  }
  .right {
    text-align: right;
  }
  .mono {
    font-family: "Menlo", "SFMono-Regular", Consolas, "Liberation Mono",
      "Courier New", monospace;
    white-space: pre-wrap;
    background: #fafafa;
    border: 1px solid #ddd;
    padding: 6px;
    border-radius: 3px;
    font-size: 13px;
  }
  .hint {
    font-size: 12px;
    color: #555;
    line-height: 1.5;
  }
</style>
</head>
<body>
  <h1>Corner City Gent 点单打印</h1>

  <!-- 1. 导入菜单（从 Excel 导出 CSV 粘贴） -->
  <div class="section">
    <h2>1. 导入菜单（编号, 中文名, 荷兰语名, 单价）</h2>
    <p class="hint">
      在 Excel 中整理好菜单后，导出为 CSV 或复制为“编号,中文名,荷兰语名,单价”的多行文本，粘贴到下面文本框。<br>
      示例：<br>
      <code>31,古老鸡,kip zoetzure,11.50</code><br>
      <code>65,鸡面,bami kip,11.80</code>
    </p>
    <textarea id="menuInput"></textarea>
    <button class="primary" onclick="importMenu()">导入菜单</button>
    <span id="menuStatus" class="hint"></span>
  </div>

  <!-- 2. 按编号加菜 -->
  <div class="section">
    <h2>2. 按编号加菜</h2>
    <label>
      编号：
      <input type="text" id="codeInput" placeholder="如 31">
    </label>
    <label>
      数量：
      <input type="number" id="qtyInput" value="1" min="1" step="1">
    </label>
    <button class="primary" onclick="addByCode()">按编号加入</button>
    <p class="hint">先导入菜单，然后输入编号和数量即可加到当前订单。</p>
  </div>

  <!-- 3. 当前订单 -->
  <div class="section">
    <h2>3. 当前订单</h2>
    <div style="overflow-x:auto;">
      <table id="orderTable">
        <thead>
          <tr>
            <th>编号</th>
            <th>中文名</th>
            <th>荷兰语名</th>
            <th>单价 (€)</th>
            <th>数量</th>
            <th>小计 (€)</th>
            <th>操作</th>
          </tr>
        </thead>
        <tbody id="orderBody">
          <!-- 动态填充 -->
        </tbody>
      </table>
    </div>
    <p class="right" style="margin-top:6px;">
      合计： € <span id="totalAmount">0.00</span>
    </p>
    <button class="danger" onclick="removeLast()">删除最后一项</button>
    <button onclick="clearOrder()">清空订单</button>
  </div>

  <!-- 4. 生成 & 打印小票 -->
  <div class="section">
    <h2>4. 生成打印内容</h2>
    <button class="primary" onclick="printBoth()">打印两联（顾客联 + 厨房联）</button>
    <button onclick="printCustomer()">只打印顾客联</button>
    <button onclick="printKitchen()">只打印厨房联</button>
    <p class="hint">
      说明：本页面专门配合 RawBT 使用。请在 RawBT 里用 <b>In-APP browser</b> 打开本网址，<br>
      完成点单后，点击上面的打印按钮（不要使用右上角 RawBT 自带的打印图标）。<br>
      若想先看内容，下方“顾客联 / 厨房联”会显示预览文本。
    </p>
  </div>

  <!-- 5. 顾客联预览 -->
  <div class="section">
    <h2>=== 顾客联 Customer ===</h2>
    <div id="customerPreview" class="mono"></div>
  </div>

  <!-- 6. 厨房联预览 -->
  <div class="section">
    <h2>=== 厨房联 Kitchen ===</h2>
    <div id="kitchenPreview" class="mono"></div>
  </div>

<script>
  // 菜单：code -> { code, cn, nl, price }
  const menuMap = {};
  // 当前订单：[{ code, cn, nl, price, qty }]
  let order = [];

  function importMenu() {
    const text = document.getElementById('menuInput').value.trim();
    const statusEl = document.getElementById('menuStatus');
    if (!text) {
      alert('请先在上方文本框粘贴菜单数据。');
      return;
    }
    let count = 0;
    const lines = text.split(/\r?\n/);
    for (const line of lines) {
      const t = line.trim();
      if (!t) continue;
      const parts = t.split(',');
      if (parts.length < 4) continue;
      const code = parts[0].trim();
      const cn = parts[1].trim();
      const nl = parts[2].trim();
      let priceStr = parts[3].trim().replace(',', '.');
      const price = parseFloat(priceStr);
      if (!code || !cn || !nl || isNaN(price)) continue;
      menuMap[code] = { code, cn, nl, price };
      count++;
    }
    statusEl.textContent = `导入菜单完成，共 ${count} 项。`;
    if (count === 0) {
      alert('没有成功导入菜单，请检查格式是否为：编号,中文名,荷兰语名,单价');
    }
  }

  function addByCode() {
    const code = document.getElementById('codeInput').value.trim();
    const qtyStr = document.getElementById('qtyInput').value.trim();
    const qty = parseInt(qtyStr, 10);
    if (!code) {
      alert('请输入菜品编号。');
      return;
    }
    if (!menuMap[code]) {
      alert('菜单中找不到编号：' + code + '，请确认已经导入菜单。');
      return;
    }
    if (!qty || qty <= 0) {
      alert('数量必须是大于 0 的整数。');
      return;
    }
    const item = menuMap[code];
    // 如果已存在则累加数量
    const existing = order.find(o => o.code === code);
    if (existing) {
      existing.qty += qty;
    } else {
      order.push({
        code: item.code,
        cn: item.cn,
        nl: item.nl,
        price: item.price,
        qty: qty
      });
    }
    renderOrder();
  }

  function removeLast() {
    if (order.length === 0) return;
    order.pop();
    renderOrder();
  }

  function clearOrder() {
    if (!confirm('确定要清空当前订单吗？')) return;
    order = [];
    renderOrder();
  }

  function renderOrder() {
    const tbody = document.getElementById('orderBody');
    tbody.innerHTML = '';
    let total = 0;
    order.forEach((item, index) => {
      const tr = document.createElement('tr');
      const subtotal = item.price * item.qty;
      total += subtotal;

      tr.innerHTML = `
        <td>${item.code}</td>
        <td>${escapeHtml(item.cn)}</td>
        <td>${escapeHtml(item.nl)}</td>
        <td class="right">€ ${item.price.toFixed(2)}</td>
        <td>${item.qty}</td>
        <td class="right">€ ${subtotal.toFixed(2)}</td>
        <td><button onclick="deleteRow(${index})">删</button></td>
      `;
      tbody.appendChild(tr);
    });
    document.getElementById('totalAmount').textContent = total.toFixed(2);
    updatePreviews();
  }

  function deleteRow(index) {
    order.splice(index, 1);
    renderOrder();
  }

  function escapeHtml(str) {
    return String(str)
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;');
  }

  // 生成顾客联 / 厨房联文本
  function buildCustomerText() {
    let lines = [];
    lines.push('=== 顾客联 Customer ===');
    lines.push('');
    lines.push('编号  菜名(NL)                 单价   数量   小计');
    lines.push('----------------------------------------------');
    let total = 0;
    order.forEach(item => {
      const subtotal = item.price * item.qty;
      total += subtotal;
      const code = padRight(item.code, 4);
      const name = padRight(item.nl, 20);
      const price = padLeft(item.price.toFixed(2), 6);
      const qty = padLeft(String(item.qty), 3);
      const subStr = padLeft(subtotal.toFixed(2), 6);
      lines.push(`${code} ${name} ${price}  ${qty}  ${subStr}`);
    });
    lines.push('----------------------------------------------');
    lines.push('Total: € ' + total.toFixed(2));
    return lines.join('\n');
  }

  function buildKitchenText() {
    let lines = [];
    lines.push('=== 厨房联 ===');
    lines.push('');
    // 只出现一次中文名：例如 "2x 古老鸡"
    order.forEach(item => {
      lines.push(`${item.qty}x ${item.cn}`);
    });
    return lines.join('\n');
  }

  function updatePreviews() {
    const customerText = order.length ? buildCustomerText() : '(当前没有菜品)';
    const kitchenText = order.length ? buildKitchenText() : '(当前没有菜品)';
    document.getElementById('customerPreview').textContent = customerText;
    document.getElementById('kitchenPreview').textContent = kitchenText;
  }

  function padRight(str, length) {
    str = String(str);
    while (str.length < length) str += ' ';
    return str;
  }

  function padLeft(str, length) {
    str = String(str);
    while (str.length < length) str = ' ' + str;
    return str;
  }

  // ===== RawBT 打印桥接 =====
  function sendToRawBT(text) {
    if (!text) {
      alert('没有可打印的内容。');
      return;
    }
    // RawBT 比较喜欢 CRLF，可以稍微兼容一下
    const payload = text.replace(/\n/g, '\r\n');
    const url = 'rawbt:' + encodeURIComponent(payload);
    try {
      window.location.href = url;
    } catch (e) {
      alert('无法调用 RawBT 打印：' + e);
    }
  }

  function printCustomer() {
    if (order.length === 0) {
      alert('当前订单为空，无法打印。');
      return;
    }
    const text = buildCustomerText();
    document.getElementById('customerPreview').textContent = text;
    sendToRawBT(text);
  }

  function printKitchen() {
    if (order.length === 0) {
      alert('当前订单为空，无法打印。');
      return;
    }
    const text = buildKitchenText();
    document.getElementById('kitchenPreview').textContent = text;
    sendToRawBT(text);
  }

  function printBoth() {
    if (order.length === 0) {
      alert('当前订单为空，无法打印。');
      return;
    }
    const customer = buildCustomerText();
    const kitchen = buildKitchenText();
    const combined = customer + '\r\n\r\n' + kitchen;
    document.getElementById('customerPreview').textContent = customer;
    document.getElementById('kitchenPreview').textContent = kitchen;
    sendToRawBT(combined);
  }

  // 初始预览
  updatePreviews();
</script>
</body>
</html>
