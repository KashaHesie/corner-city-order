<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>Corner City Gent 点单打印</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{
    font-family: -apple-system, BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Microsoft YaHei",sans-serif;
    margin: 8px;
    font-size: 16px;
}

h2{
    font-size: 20px;
    margin-top:20px;
    margin-bottom:6px;
    font-weight: bold;
}

input,textarea,button{
    font-size:18px;
    padding:6px;
}
table{
    width:100%;
    border-collapse: collapse;
    margin-top:6px;
}
th,td{
    border:1px solid #ddd;
    padding:6px;
    font-size:18px;
}
button{
    margin-top:6px;
}

.big-cn{
    font-size:48px;
    font-weight:bold;
}
</style>
</head>

<body>

<h2>1. 导入菜单（粘贴 Excel 导出的 CSV 文本）</h2>
<textarea id="csvInput" rows="4" style="width:100%;"></textarea><br>
<button onclick="importCSV()">导入菜单</button>
<span id="menuCount"></span>

<h2>2. 按编号加菜</h2>
编号：<input id="addNum" size="4">
数量：<input id="addQty" size="4" value="1">
<button onclick="addItem()">按编号加入</button>

<h2>3. 当前订单</h2>
<table id="orderTable">
<thead>
<tr>
<th>编号</th><th>中文名</th><th>荷兰语名</th><th>单价 (€)</th><th>数量</th><th>小计</th><th>操作</th>
</tr>
</thead>
<tbody></tbody>
</table>
<div style="margin-top:6px;">
<button onclick="removeLast()">删除最后一项</button>
<button onclick="clearOrder()">清空订单</button>
</div>

<h2>4. 生成打印内容</h2>
<button onclick="printBoth()">打印两联（顾客 + 厨房）</button>
<button onclick="printCustomer()">只打印顾客联</button>
<button onclick="printKitchen()">只打印厨房联</button>

<hr>
<h2>=== 顾客联 Customer ===</h2>
<div id="previewCustomer"></div>

<h2>=== 厨房联 Kitchen ===</h2>
<div id="previewKitchen"></div>

<script>
// ====== 1. 菜单数据 ======
let menu = {}; // {编号:{cn, nl, price}}

// ====== 2. 导入 CSV ======
function importCSV(){
    const text = document.getElementById("csvInput").value.trim();
    if(!text){
        alert("请粘贴 CSV 文本");
        return;
    }

    menu = {};
    let lines = text.split(/\r?\n/);

    lines.forEach(line=>{
        let parts = line.split(",");
        if(parts.length < 4) return;

        let num = parts[0].trim();
        let cn = parts[1].trim();
        let nl = parts[2].trim();
        let price = parseFloat(parts[3].trim());

        menu[num] = {cn,nl,price};
    });

    document.getElementById("menuCount").innerText = `导入菜单完成，共 ${Object.keys(menu).length} 项。`;
}

// ====== 3. 订单管理 ======
let order = [];

function addItem(){
    let num = document.getElementById("addNum").value.trim();
    let qty = parseInt(document.getElementById("addQty").value);

    if(!menu[num]){
        alert("编号不存在");
        return;
    }

    order.push({
        num,
        cn: menu[num].cn,
        nl: menu[num].nl,
        price: menu[num].price,
        qty
    });

    renderOrder();
}

function removeLast(){
    order.pop();
    renderOrder();
}

function clearOrder(){
    order = [];
    renderOrder();
}

function renderOrder(){
    const tbody = document.querySelector("#orderTable tbody");
    tbody.innerHTML = "";

    let total = 0;

    order.forEach((item,idx)=>{
        let tr = document.createElement("tr");
        let sub = item.qty * item.price;
        total += sub;

        tr.innerHTML = `
            <td>${item.num}</td>
            <td>${item.cn}</td>
            <td>${item.nl}</td>
            <td>${item.price.toFixed(2)}</td>
            <td>${item.qty}</td>
            <td>${sub.toFixed(2)}</td>
            <td><button onclick="del(${idx})">删</button></td>
        `;
        tbody.appendChild(tr);
    });

    let tr = document.createElement("tr");
    tr.innerHTML = `<td colspan="7" style="text-align:right;font-size:20px;font-weight:bold;">
        合计：€ ${total.toFixed(2)}
    </td>`;
    tbody.appendChild(tr);

    buildPreviews();
}

function del(i){
    order.splice(i,1);
    renderOrder();
}

// ====== 4. 生成预览内容 ======
function buildPreviews(){
    let cust = "";
    let kit = "";

    let total = 0;

    order.forEach(it=>{
        let sub = it.qty * it.price;
        total += sub;

        cust += `${it.num}  ${it.nl}   €${it.price} × ${it.qty}  = €${sub.toFixed(2)}<br>`;
        kit  += `<span class="big-cn">${it.qty}× ${it.cn}</span><br>`;
    });

    cust += `<br><b>Total: € ${total.toFixed(2)}</b><br>`;

    document.getElementById("previewCustomer").innerHTML = cust;
    document.getElementById("previewKitchen").innerHTML = kit;
}

// ====== 5. RawBT 打印（使用 ESC/POS + GBK编码） ======
function sendToRawBT(html){
    let url = "rawbt:base64," + btoa(unescape(encodeURIComponent(html)));
    window.location.href = url;
}

function wrap(text){
    return text + "\n";
}

function printCustomer(){
    let html = document.getElementById("previewCustomer").innerHTML.replace(/<br>/g,"\n");
    sendToRawBT(html);
}

function printKitchen(){
    let html = document.getElementById("previewKitchen").innerHTML.replace(/<br>/g,"\n");
    sendToRawBT(html);
}

function printBoth(){
    printCustomer();
    setTimeout(printKitchen,500);
}
</script>

</body>
</html>