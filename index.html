<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>Corner City Gent 点单打印</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
        "Helvetica Neue", Arial, "Microsoft YaHei", sans-serif;
      margin: 8px;
      font-size: 15px;
    }
    h1 {
      font-size: 22px;
      margin: 8px 0 10px;
      text-align: center;
    }
    h2 {
      font-size: 18px;
      margin: 10px 0 6px;
    }
    textarea {
      width: 100%;
      box-sizing: border-box;
      min-height: 80px;
      font-size: 14px;
    }
    input[type="text"],
    input[type="number"] {
      font-size: 16px;
      padding: 4px 6px;
      box-sizing: border-box;
    }
    button {
      font-size: 15px;
      padding: 6px 10px;
      margin: 4px 2px;
      border-radius: 4px;
      border: none;
      color: #fff;
      background-color: #1976d2;
    }
    button.secondary {
      background-color: #555;
    }
    button.danger {
      background-color: #c62828;
    }
    button:disabled {
      background-color: #aaa;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 6px;
      font-size: 14px;
    }
    th, td {
      border-bottom: 1px solid #ccc;
      padding: 3px;
      text-align: left;
    }
    th {
      background: #f4f4f4;
    }
    .right {
      text-align: right;
    }
    .status {
      font-size: 13px;
      color: #555;
      margin-top: 4px;
    }
    .total-row {
      font-weight: bold;
    }
    .section {
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 8px;
      margin-bottom: 10px;
    }
    .hint {
      font-size: 12px;
      color: #777;
      line-height: 1.4;
    }
    pre.preview {
      white-space: pre-wrap;
      word-break: break-all;
      font-size: 13px;
      border: 1px dashed #ccc;
      padding: 6px;
      margin-top: 4px;
      max-height: 180px;
      overflow-y: auto;
      background: #fafafa;
    }
    /* 打印视图，只放小票纯文本，字体尽量大，方便厨房看 */
    #printView {
      display: none;
      white-space: pre-wrap;
      word-break: break-all;
      font-size: 28px;    /* 这里只影响屏幕显示，真正纸上大小由 RawBT 里 double height/width 决定 */
      line-height: 1.4;
    }
  </style>
</head>
<body>
  <!-- 整个点单界面包在 app 里，打印时会被整体隐藏 -->
  <div id="app">
    <h1>Corner City Gent 点单打印</h1>

    <!-- 1. 导入菜单 -->
    <div class="section">
      <h2>1. 导入菜单（粘贴自 Excel 的 CSV 文本）</h2>
      <textarea
        id="menuInput"
        placeholder="每行一条菜品，格式：编号,中文名,荷兰语名,单价&#10;例如：31,古老鸡,kip zoetzure,12.30"
      ></textarea>
      <button id="btnImportMenu">导入菜单</button>
      <div id="menuStatus" class="status"></div>
      <div class="hint">
        示例：<br />
        <code>31,古老鸡,kip zoetzure,12.30</code><br />
        <code>65,鸡面,bami kip,11.80</code>
      </div>
    </div>

    <!-- 2. 按编号加菜 -->
    <div class="section">
      <h2>2. 按编号加菜</h2>
      <div>
        编号：
        <input id="codeInput" type="text" style="width: 80px" />
        数量：
        <input id="qtyInput" type="number" style="width: 80px" value="1" />
        <button id="btnAddByCode">按编号加入</button>
      </div>
      <div id="orderStatus" class="status"></div>
    </div>

    <!-- 3. 当前订单 -->
    <div class="section">
      <h2>3. 当前订单</h2>
      <table>
        <thead>
          <tr>
            <th>编号</th>
            <th>中文名</th>
            <th>荷兰语名</th>
            <th class="right">单价 (€)</th>
            <th class="right">数量</th>
            <th class="right">小计</th>
          </tr>
        </thead>
        <tbody id="orderBody"></tbody>
        <tfoot>
          <tr class="total-row">
            <td colspan="5" class="right">合计：</td>
            <td class="right" id="orderTotal">€ 0.00</td>
          </tr>
        </tfoot>
      </table>
      <div style="margin-top: 6px">
        <button id="btnRemoveLast" class="secondary">删除最后一项</button>
        <button id="btnClearOrder" class="danger">清空订单</button>
      </div>
    </div>

    <!-- 4. 生成打印内容 -->
    <div class="section">
      <h2>4. 生成打印内容</h2>
      <button id="btnPrintBoth">打印两联（顾客联 + 厨房联）</button>
      <button id="btnPrintCustomerOnly" class="secondary">只打印顾客联</button>
      <button id="btnPrintKitchenOnly" class="secondary">只打印厨房联</button>

      <div class="hint" style="margin-top: 6px">
        ★ 使用方法：<br />
        1）在 RawBT 中选择“Visit app site”，打开
        <code>https://corner-city.vercel.app/</code><br />
        2）输入订单后，点击上面的其中一个按钮；<br />
        3）此页面会切换成<b>只有小票文字</b>的打印视图，<b>这时再点击 RawBT 顶部的小打印机图标</b>；<br />
        4）打印完成后，按浏览器“返回”或重新打开链接，开始下一单。<br />
        5）纸上字体变大：在 RawBT Demo 页面勾选 Double height / Double width 并保存为默认即可。
      </div>

      <h3 style="margin-top: 10px; font-size: 16px">预览（顾客联）</h3>
      <pre id="previewCustomer" class="preview"></pre>
      <h3 style="margin-top: 6px; font-size: 16px">预览（厨房联）</h3>
      <pre id="previewKitchen" class="preview"></pre>
    </div>
  </div>

  <!-- 打印视图：只包含要送给打印机的纯文本 -->
  <pre id="printView"></pre>

  <script>
    // ========== 数据结构 ==========
    const menu = {};  // 编号 => { code, zh, nl, price }
    const order = []; // 当前订单

    // ========== 1. 导入菜单 ==========
    function importMenu() {
      const text = document.getElementById("menuInput").value.trim();
      const status = document.getElementById("menuStatus");

      if (!text) {
        status.textContent = "请输入菜单内容。";
        return;
      }

      let count = 0;
      const errorLines = [];

      text.split(/\r?\n/).forEach((line, index) => {
        const trimmed = line.trim();
        if (!trimmed) return;

        const parts = trimmed.split(",");
        if (parts.length < 4) {
          errorLines.push(index + 1);
          return;
        }

        const code = parts[0].trim();
        const zh = parts[1].trim();
        const nl = parts[2].trim();
        const priceStr = parts[3].trim().replace(",", ".");
        const price = parseFloat(priceStr);

        if (!code || !zh || !nl || isNaN(price)) {
          errorLines.push(index + 1);
          return;
        }

        menu[code] = { code, zh, nl, price };
        count++;
      });

      if (count === 0) {
        status.textContent =
          "导入失败：没有有效数据，请检查每行是否为“编号,中文名,荷兰语名,单价”。";
      } else {
        status.textContent = `导入菜单完成，共 ${count} 项。`;
        if (errorLines.length) {
          status.textContent += `（第 ${errorLines.join(
            ","
          )} 行格式有问题，已跳过）`;
        }
      }
    }

    // ========== 2. 按编号加菜 ==========
    function addByCode() {
      const codeInput = document.getElementById("codeInput");
      const qtyInput = document.getElementById("qtyInput");
      const status = document.getElementById("orderStatus");

      const code = (codeInput.value || "").trim();
      const qty = parseInt(qtyInput.value, 10) || 0;

      if (!menu[code]) {
        status.textContent = "该编号在菜单中不存在，请检查。";
        return;
      }
      if (qty <= 0) {
        status.textContent = "数量必须大于 0。";
        return;
      }

      const item = menu[code];
      let row = order.find((r) => r.code === code);
      if (row) {
        row.qty += qty;
      } else {
        row = { ...item, qty };
        order.push(row);
      }

      status.textContent = "";
      renderOrder();
    }

    // ========== 3. 渲染当前订单 ==========
    function renderOrder() {
      const tbody = document.getElementById("orderBody");
      const totalCell = document.getElementById("orderTotal");
      tbody.innerHTML = "";

      let total = 0;
      order.forEach((item) => {
        const lineTotal = item.price * item.qty;
        total += lineTotal;

        const tr = document.createElement("tr");

        const tdCode = document.createElement("td");
        tdCode.textContent = item.code;
        tr.appendChild(tdCode);

        const tdZh = document.createElement("td");
        tdZh.textContent = item.zh;
        tr.appendChild(tdZh);

        const tdNl = document.createElement("td");
        tdNl.textContent = item.nl;
        tr.appendChild(tdNl);

        const tdPrice = document.createElement("td");
        tdPrice.className = "right";
        tdPrice.textContent = item.price.toFixed(2);
        tr.appendChild(tdPrice);

        const tdQty = document.createElement("td");
        tdQty.className = "right";
        tdQty.textContent = item.qty;
        tr.appendChild(tdQty);

        const tdLine = document.createElement("td");
        tdLine.className = "right";
        tdLine.textContent = lineTotal.toFixed(2);
        tr.appendChild(tdLine);

        tbody.appendChild(tr);
      });

      totalCell.textContent = "€ " + total.toFixed(2);

      // 更新预览
      document.getElementById("previewCustomer").textContent =
        buildCustomerText();
      document.getElementById("previewKitchen").textContent =
        buildKitchenText();
    }

    function removeLast() {
      if (order.length > 0) {
        order.pop();
        renderOrder();
      }
    }

    function clearOrder() {
      order.length = 0;
      renderOrder();
    }

    // ========== 4. 构造顾客联 / 厨房联纯文本 ==========
    function buildCustomerText() {
      if (order.length === 0) return "=== 顾客联 Customer ===\n(当前无订单)\n";

      const lines = [];
      lines.push("=== 顾客联 Customer ===");
      lines.push("");

      let total = 0;

      order.forEach((item) => {
        const lineTotal = item.price * item.qty;
        total += lineTotal;
        // 顾客联：只显示荷兰语名 + 数量 + 单价/小计（不再带中文）
        lines.push(`${item.nl} × ${item.qty}`);
        lines.push(
          `€ ${item.price.toFixed(2)}   = € ${lineTotal.toFixed(2)}`
        );
        lines.push("");
      });

      lines.push("--------------------------------");
      lines.push(`Total: € ${total.toFixed(2)}`);
      lines.push("");

      return lines.join("\n");
    }

    function buildKitchenText() {
      if (order.length === 0) return "=== 厨房联 ===\n(当前无订单)\n";

      const lines = [];
      lines.push("=== 厨房联 ===");
      lines.push("");

      // 厨房联：大中文名 + 数量，例如 “2× 古老鸡”
      order.forEach((item) => {
        lines.push(`${item.qty}× ${item.zh}`);
      });

      lines.push("");
      return lines.join("\n");
    }

    // ========== 5. 切换到“打印视图” ==========
    function showPrintView(text) {
      // 点单界面隐藏，只把小票纯文本放到 printView 里
      document.getElementById("app").style.display = "none";
      const pre = document.getElementById("printView");
      pre.style.display = "block";
      pre.textContent = text; // 纯文本，不含任何 HTML 标签

      alert("现在请点击 RawBT 顶部的小打印机图标进行打印。\n打印完成后，按返回键或重新打开链接开始下一单。");
    }

    function printBoth() {
      const allText = buildCustomerText() + "\n\n\n" + buildKitchenText();
      showPrintView(allText);
    }

    function printCustomerOnly() {
      showPrintView(buildCustomerText());
    }

    function printKitchenOnly() {
      showPrintView(buildKitchenText());
    }

    // ========== 6. 事件绑定 ==========
    document.getElementById("btnImportMenu").addEventListener("click", importMenu);
    document.getElementById("btnAddByCode").addEventListener("click", addByCode);
    document.getElementById("btnRemoveLast").addEventListener("click", removeLast);
    document.getElementById("btnClearOrder").addEventListener("click", clearOrder);

    document
      .getElementById("btnPrintBoth")
      .addEventListener("click", printBoth);
    document
      .getElementById("btnPrintCustomerOnly")
      .addEventListener("click", printCustomerOnly);
    document
      .getElementById("btnPrintKitchenOnly")
      .addEventListener("click", printKitchenOnly);
  </script>
</body>
</html>