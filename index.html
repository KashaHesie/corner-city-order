<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>Corner City Gent 点单打印</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    /* ====== 屏幕样式（正常操作用） ====== */
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
        "Helvetica Neue", Arial, "Microsoft YaHei", sans-serif;
      margin: 8px;
      font-size: 15px;
    }
    h1 {
      font-size: 22px;
      margin: 4px 0 8px;
    }
    h2 {
      font-size: 18px;
      margin: 12px 0 6px;
    }
    textarea {
      width: 100%;
      min-height: 80px;
      box-sizing: border-box;
      font-family: monospace;
    }
    input[type="text"],
    input[type="number"] {
      padding: 4px 6px;
      font-size: 16px;
      box-sizing: border-box;
    }
    button {
      padding: 6px 10px;
      margin: 4px 2px;
      border: none;
      border-radius: 4px;
      font-size: 14px;
      cursor: pointer;
    }
    button.primary {
      background: #1976d2;
      color: #fff;
    }
    button.danger {
      background: #d32f2f;
      color: #fff;
    }
    button.gray {
      background: #555;
      color: #fff;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 6px;
    }
    th, td {
      border-bottom: 1px solid #ddd;
      padding: 4px 2px;
      text-align: left;
      font-size: 14px;
    }
    th:nth-child(1),
    td:nth-child(1) {
      width: 12%;
    }
    th:nth-child(2),
    td:nth-child(2) {
      width: 28%;
    }
    th:nth-child(3),
    td:nth-child(3) {
      width: 30%;
    }
    th:nth-child(4),
    td:nth-child(4) {
      width: 10%;
      text-align: right;
    }
    th:nth-child(5),
    td:nth-child(5) {
      width: 10%;
      text-align: right;
    }
    th:nth-child(6),
    td:nth-child(6) {
      width: 10%;
      text-align: right;
    }

    #current-total {
      text-align: right;
      font-weight: bold;
      margin-top: 6px;
    }

    .section-box {
      border: 1px solid #ddd;
      padding: 8px;
      margin-bottom: 8px;
      border-radius: 4px;
    }

    .print-buttons button {
      min-width: 120px;
    }

    /* 打印预览用的文字（预先给你看） */
    #preview-area {
      margin-top: 8px;
      border-top: 1px dashed #aaa;
      padding-top: 6px;
    }
    #customer-preview, #kitchen-preview {
      margin-top: 6px;
      padding: 6px;
      background: #fafafa;
      white-space: pre-wrap;
      font-family: monospace;
    }

    /* ====== 真正打印时的样式 ====== */
    @media print {
      /* 基本设置：把屏幕上的 UI 全部隐藏 */
      body {
        margin: 0;
        font-size: 14pt;
      }
      .screen-only {
        display: none !important;
      }

      /* 只打印这个区域 */
      #print-area {
        display: block !important;
        padding: 0 4px;
      }

      #print-area pre {
        font-family: monospace;
        white-space: pre-wrap;
      }

      /* 顾客联字体：比现在大很多，约 5 倍效果 */
      #customer-print {
        font-size: 18pt;
      }

      /* 厨房联字体：中文放到最大，约 5 倍，现在你可以自己再调 */
      #kitchen-print {
        font-size: 26pt;
      }

      /* 双联打印时，每联之间强制换页 */
      .receipt-block {
        page-break-after: always;
      }

      /* 根据 body 上的 data-print 控制只打哪一联 */
      body[data-print="customer"] #kitchen-print-block {
        display: none !important;
      }
      body[data-print="kitchen"] #customer-print-block {
        display: none !important;
      }
      /* 两联都打时，两个 block 都显示 */
      body[data-print="both"] #customer-print-block,
      body[data-print="both"] #kitchen-print-block {
        display: block !important;
      }
    }

    /* 屏幕上不需要真正的打印区域显示出来 */
    #print-area {
      display: none;
    }
  </style>
</head>
<body data-print="both">
  <div class="screen-only">
    <h1>Corner City Gent 点单打印</h1>

    <!-- 1. 导入菜单 -->
    <div class="section-box">
      <h2>1. 导入菜单（粘贴自 Excel 的 CSV 文本）</h2>
      <p>每行格式：编号,中文名,荷兰语名,单价</p>
      <p>示例：<code>31,古老鸡,kip zoetzure,12.30</code></p>
      <textarea id="menu-input" placeholder="在这里粘贴菜单，每行一个菜品"></textarea>
      <button class="primary" id="btn-import-menu">导入菜单</button>
      <span id="menu-status"></span>
    </div>

    <!-- 2. 按编号加菜 -->
    <div class="section-box">
      <h2>2. 按编号加菜</h2>
      编号：
      <input type="text" id="dish-code" style="width: 80px;">
      数量：
      <input type="number" id="dish-qty" style="width: 80px;" value="1" min="1">
      <button class="primary" id="btn-add-by-code">按编号加入</button>
      <span id="add-status"></span>
    </div>

    <!-- 3. 当前订单 -->
    <div class="section-box">
      <h2>3. 当前订单</h2>
      <table>
        <thead>
          <tr>
            <th>编号</th>
            <th>中文名</th>
            <th>荷兰语名</th>
            <th>单价 (€)</th>
            <th>数量</th>
            <th>小计</th>
          </tr>
        </thead>
        <tbody id="order-body"></tbody>
      </table>
      <div id="current-total">合计：€ 0.00</div>
      <div style="margin-top:6px;">
        <button class="danger" id="btn-remove-last">删除最后一项</button>
        <button class="gray" id="btn-clear-order">清空订单</button>
      </div>
    </div>

    <!-- 4. 生成打印内容 & 打印按钮 -->
    <div class="section-box">
      <h2>4. 生成打印内容</h2>
      <div class="print-buttons">
        <button class="primary" id="btn-gen-and-print-both">打印两联（顾客联 + 厨房联）</button>
        <button id="btn-gen-and-print-cust">只打印顾客联</button>
        <button id="btn-gen-and-print-kitchen">只打印厨房联</button>
      </div>
      <p style="font-size: 13px; margin-top:6px;">
        提示：先在上方生成订单内容，然后点击其中一个按钮。<br>
        浏览器会打开打印界面，选择 RawBT 作为打印机，即可把内容通过 Xprinter 打印出来。
      </p>

      <div id="preview-area">
        <strong>打印预览（屏幕上查看用，不会被打印整页）</strong>
        <div id="customer-preview"></div>
        <div id="kitchen-preview"></div>
      </div>
    </div>
  </div>

  <!-- 真正给打印用的纯文本区域（window.print 时只会打印这里） -->
  <div id="print-area">
    <div id="customer-print-block" class="receipt-block">
      <pre id="customer-print"></pre>
    </div>
    <div id="kitchen-print-block" class="receipt-block">
      <pre id="kitchen-print"></pre>
    </div>
  </div>

  <script>
    // 菜单与订单数据
    const menuMap = new Map(); // code -> {code, cn, nl, price}
    const orderItems = [];     // {code, cn, nl, price, qty}

    const menuInput = document.getElementById('menu-input');
    const menuStatus = document.getElementById('menu-status');
    const orderBody = document.getElementById('order-body');
    const currentTotalEl = document.getElementById('current-total');
    const addStatus = document.getElementById('add-status');

    const customerPreview = document.getElementById('customer-preview');
    const kitchenPreview = document.getElementById('kitchen-preview');
    const customerPrint = document.getElementById('customer-print');
    const kitchenPrint = document.getElementById('kitchen-print');

    function parsePrice(str) {
      if (!str) return 0;
      str = String(str).replace(',', '.').trim();
      const v = parseFloat(str);
      return isNaN(v) ? 0 : v;
    }

    function formatMoney(num) {
      return num.toFixed(2);
    }

    function importMenu() {
      menuMap.clear();
      const lines = menuInput.value.split(/\r?\n/);
      let ok = 0;
      for (const line of lines) {
        const trimmed = line.trim();
        if (!trimmed) continue;
        const parts = trimmed.split(',');
        if (parts.length < 4) continue;
        const code = parts[0].trim();
        const cn = parts[1].trim();
        const nl = parts[2].trim();
        const price = parsePrice(parts[3]);
        if (!code || !cn || !nl || !price) continue;
        menuMap.set(code, { code, cn, nl, price });
        ok++;
      }
      menuStatus.textContent = `导入菜单完成，共 ${ok} 项。`;
    }

    function renderOrder() {
      orderBody.innerHTML = '';
      let total = 0;
      for (const item of orderItems) {
        const tr = document.createElement('tr');
        const subtotal = item.price * item.qty;
        total += subtotal;
        tr.innerHTML = `
          <td>${item.code}</td>
          <td>${item.cn}</td>
          <td>${item.nl}</td>
          <td>${formatMoney(item.price)}</td>
          <td>${item.qty}</td>
          <td>${formatMoney(subtotal)}</td>
        `;
        orderBody.appendChild(tr);
      }
      currentTotalEl.textContent = '合计：€ ' + formatMoney(total);
    }

    function addByCode() {
      addStatus.textContent = '';
      const codeInput = document.getElementById('dish-code');
      const qtyInput = document.getElementById('dish-qty');
      const code = codeInput.value.trim();
      const qty = parseInt(qtyInput.value, 10) || 1;

      if (!code) {
        addStatus.textContent = '请输入编号';
        return;
      }
      const item = menuMap.get(code);
      if (!item) {
        addStatus.textContent = '菜单中找不到该编号';
        return;
      }
      const existing = orderItems.find(it => it.code === code);
      if (existing) {
        existing.qty += qty;
      } else {
        orderItems.push({
          code: item.code,
          cn: item.cn,
          nl: item.nl,
          price: item.price,
          qty
        });
      }
      renderOrder();
      addStatus.textContent = '已加入：' + item.cn;
      codeInput.value = '';
      qtyInput.value = '1';
    }

    function removeLast() {
      if (orderItems.length > 0) {
        orderItems.pop();
        renderOrder();
      }
    }

    function clearOrder() {
      orderItems.length = 0;
      renderOrder();
    }

    // 生成顾客联 / 厨房联的纯文本
    function buildReceipts() {
      if (orderItems.length === 0) {
        alert('当前订单为空');
        return { customer: '', kitchen: '' };
      }
      let total = 0;

      // 顾客联：只要 荷兰语名 x 份数 + Total
      let custLines = [];
      custLines.push('=== 顾客联 Customer ===');
      custLines.push('');
      for (const item of orderItems) {
        const subtotal = item.price * item.qty;
        total += subtotal;
        custLines.push(
          `${item.nl} × ${item.qty}`
        );
      }
      custLines.push('');
      custLines.push(`Total: € ${formatMoney(total)}`);

      // 厨房联：只要 份数 × 中文名
      let kitLines = [];
      kitLines.push('=== 厨房联 ===');
      kitLines.push('');
      for (const item of orderItems) {
        kitLines.push(`${item.qty}× ${item.cn}`);
      }

      const custText = custLines.join('\n');
      const kitText = kitLines.join('\n');

      // 在屏幕上预览
      customerPreview.textContent = custText;
      kitchenPreview.textContent = kitText;

      // 给打印区域
      customerPrint.textContent = custText;
      kitchenPrint.textContent = kitText;

      return { customer: custText, kitchen: kitText };
    }

    function generateAndPrint(mode) {
      const res = buildReceipts();
      if (!res.customer) return; // 空订单已提示

      document.body.setAttribute('data-print', mode); // both / customer / kitchen
      // 触发浏览器打印（Chrome 里选择 RawBT）
      window.print();
      // 恢复默认
      document.body.setAttribute('data-print', 'both');
    }

    // 事件绑定
    document.getElementById('btn-import-menu').addEventListener('click', importMenu);
    document.getElementById('btn-add-by-code').addEventListener('click', addByCode);
    document.getElementById('btn-remove-last').addEventListener('click', removeLast);
    document.getElementById('btn-clear-order').addEventListener('click', clearOrder);

    document.getElementById('btn-gen-and-print-both')
      .addEventListener('click', () => generateAndPrint('both'));
    document.getElementById('btn-gen-and-print-cust')
      .addEventListener('click', () => generateAndPrint('customer'));
    document.getElementById('btn-gen-and-print-kitchen')
      .addEventListener('click', () => generateAndPrint('kitchen'));
  </script>
</body>
</html>