<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>Corner City Gent 点单打印</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
                 "Helvetica Neue", Arial, "Microsoft YaHei", sans-serif;
    margin: 8px;
    font-size: 14px;
  }
  h1 {
    font-size: 20px;
    margin: 6px 0 10px;
    text-align: center;
  }
  h2 {
    font-size: 16px;
    margin: 12px 0 6px;
  }
  h3 {
    font-size: 15px;
    margin: 8px 0 4px;
    text-align: center;
  }
  button {
    font-size: 14px;
    padding: 6px 10px;
    margin: 2px 4px 2px 0;
  }
  input, textarea {
    font-size: 14px;
  }
  textarea {
    width: 100%;
    min-height: 60px;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
  }
  th, td {
    border-bottom: 1px solid #ccc;
    padding: 4px 2px;
    text-align: left;
  }
  th.num, td.num {
    width: 14%;
    text-align: center;
  }
  th.name-cn, td.name-cn {
    width: 22%;
  }
  th.name-nl, td.name-nl {
    width: 28%;
  }
  th.price, td.price,
  th.qty, td.qty,
  th.subtotal, td.subtotal {
    width: 12%;
    text-align: right;
  }
  th.action, td.action {
    width: 12%;
    text-align: center;
  }
  .total-line {
    text-align: right;
    font-weight: bold;
    margin-top: 4px;
  }
  .section-box {
    border: 1px solid #ccc;
    padding: 6px;
    margin-bottom: 8px;
    border-radius: 4px;
  }
  .section-title {
    font-weight: bold;
    margin-bottom: 4px;
  }
  #printArea {
    margin-top: 8px;
  }
  #customerReceipt, #kitchenReceipt {
    margin-top: 6px;
    padding-top: 4px;
    border-top: 1px dashed #666;
  }
  #customerReceipt table {
    font-size: 13px;
  }
  .kitchen-item {
    font-size: 70px; /* 厨房联中文大号字体，约为普通字号 5 倍 */
    line-height: 1.1;
    font-weight: bold;
    margin: 8px 0;
  }
  .kitchen-item small {
    font-size: 0.4em;
    font-weight: normal;
  }
  .hint {
    font-size: 12px;
    color: #555;
  }
  @media print {
    body {
      margin: 0;
      font-size: 12px;
    }
    #controls {
      display: none;       /* 打印时隐藏点单界面，只留下联内容 */
    }
    #printArea {
      margin: 0;
    }
  }
</style>
</head>
<body>
<h1>Corner City Gent 点单打印</h1>

<div id="controls">
  <!-- 1. 导入菜单 -->
  <div class="section-box">
    <div class="section-title">1. 导入菜单（稍后可从 Excel 导出为 CSV 粘贴）</div>
    <textarea id="menuInput" placeholder="示例：&#10;31,古老鸡,kip zoetzure,11.50&#10;65,鸡面,bami kip,11.80"></textarea>
    <button id="btnImportMenu">导入菜单</button>
    <span class="hint">粘贴“编号,中文名,荷兰语名,单价(€)”每行一条。</span>
    <div id="menuStatus" class="hint"></div>
  </div>

  <!-- 2. 按编号加菜 -->
  <div class="section-box">
    <div class="section-title">2. 按编号加菜</div>
    <div>
      编号：
      <input id="codeInput" type="text" style="width:70px;" placeholder="31">
      份数：
      <input id="qtyInput" type="number" style="width:60px;" value="1" min="1">
      <button id="btnAddByCode">按编号加入</button>
    </div>
    <div id="addError" class="hint" style="color:#c00;"></div>
  </div>

  <!-- 3. 当前订单 -->
  <div class="section-box">
    <div class="section-title">3. 当前订单</div>
    <table>
      <thead>
        <tr>
          <th class="num">编号</th>
          <th class="name-cn">中文名</th>
          <th class="name-nl">荷兰语名</th>
          <th class="price">单价 (€)</th>
          <th class="qty">数量</th>
          <th class="subtotal">小计 (€)</th>
          <th class="action">操作</th>
        </tr>
      </thead>
      <tbody id="orderBody"></tbody>
    </table>
    <div class="total-line" id="orderTotal">合计：€ 0.00</div>
    <div>
      <button id="btnRemoveLast">删除最后一项</button>
      <button id="btnClearOrder">清空订单</button>
    </div>
  </div>

  <!-- 4. 生成打印内容 -->
  <div class="section-box">
    <div class="section-title">4. 生成打印内容</div>
    <div style="margin-bottom:4px;">
      <button id="btnMakeBoth">生成两联内容</button>
      <button id="btnMakeCustomer">只生成顾客联</button>
      <button id="btnMakeKitchen">只生成厨房联</button>
    </div>
    <div class="hint">
      生成后，在 RawBT 的浏览器中打开本页面，点右上角打印图标即可打印。<br>
      如果希望顾客联和厨房联是两张纸：先选“只生成顾客联”打印一次，再选“只生成厨房联”再打印一次。
    </div>
  </div>
</div>

<!-- 打印区域：顾客联 + 厨房联 -->
<div id="printArea">
  <div id="customerReceipt"></div>
  <div id="kitchenReceipt"></div>
</div>

<script>
  // 菜单：code -> {code, nameCn, nameNl, price}
  var menu = {};
  // 订单数组
  var orderItems = [];

  function formatMoney(num) {
    return num.toFixed(2);
  }

  function renderOrderTable() {
    var body = document.getElementById('orderBody');
    body.innerHTML = '';
    var total = 0;

    orderItems.forEach(function(item, index) {
      var tr = document.createElement('tr');

      var tdCode = document.createElement('td');
      tdCode.className = 'num';
      tdCode.textContent = item.code;
      tr.appendChild(tdCode);

      var tdCn = document.createElement('td');
      tdCn.className = 'name-cn';
      tdCn.textContent = item.nameCn;
      tr.appendChild(tdCn);

      var tdNl = document.createElement('td');
      tdNl.className = 'name-nl';
      tdNl.textContent = item.nameNl;
      tr.appendChild(tdNl);

      var tdPrice = document.createElement('td');
      tdPrice.className = 'price';
      tdPrice.textContent = formatMoney(item.price);
      tr.appendChild(tdPrice);

      var tdQty = document.createElement('td');
      tdQty.className = 'qty';
      tdQty.textContent = item.qty;
      tr.appendChild(tdQty);

      var subtotal = item.price * item.qty;
      total += subtotal;

      var tdSub = document.createElement('td');
      tdSub.className = 'subtotal';
      tdSub.textContent = formatMoney(subtotal);
      tr.appendChild(tdSub);

      var tdAct = document.createElement('td');
      tdAct.className = 'action';
      var btnDel = document.createElement('button');
      btnDel.textContent = '删';
      btnDel.style.fontSize = '12px';
      btnDel.onclick = function () {
        orderItems.splice(index, 1);
        renderOrderTable();
      };
      tdAct.appendChild(btnDel);
      tr.appendChild(tdAct);

      body.appendChild(tr);
    });

    document.getElementById('orderTotal').textContent =
      '合计：€ ' + formatMoney(total);
  }

  // 1. 导入菜单
  document.getElementById('btnImportMenu').addEventListener('click', function () {
    var text = document.getElementById('menuInput').value || '';
    var lines = text.split(/\r?\n/);
    var imported = 0;
    menu = {};

    lines.forEach(function(line) {
      var trimmed = line.trim();
      if (!trimmed) return;

      // 支持逗号 / 分号 / 制表符
      var parts = trimmed.split(/[,;\t]/);
      if (parts.length < 4) return;

      var code = parts[0].trim();
      var nameCn = parts[1].trim();
      var nameNl = parts[2].trim();
      var price = parseFloat(parts[3].replace(',', '.'));

      if (!code || !nameCn || !nameNl || isNaN(price)) return;

      menu[code] = {
        code: code,
        nameCn: nameCn,
        nameNl: nameNl,
        price: price
      };
      imported++;
    });

    document.getElementById('menuStatus').textContent =
      '导入菜单完成，共 ' + imported + ' 项。';
  });

  // 2. 按编号加菜
  document.getElementById('btnAddByCode').addEventListener('click', function () {
    var code = document.getElementById('codeInput').value.trim();
    var qty = parseInt(document.getElementById('qtyInput').value, 10) || 1;
    var err = document.getElementById('addError');
    err.textContent = '';

    if (!code) {
      err.textContent = '请输入编号。';
      return;
    }
    if (!menu[code]) {
      err.textContent = '在菜单中找不到编号 ' + code + '，请确认已导入菜单。';
      return;
    }
    if (qty <= 0) {
      err.textContent = '数量必须大于 0。';
      return;
    }

    var item = menu[code];
    orderItems.push({
      code: item.code,
      nameCn: item.nameCn,
      nameNl: item.nameNl,
      price: item.price,
      qty: qty
    });

    renderOrderTable();
  });

  // 删除最后一项
  document.getElementById('btnRemoveLast').addEventListener('click', function () {
    if (orderItems.length > 0) {
      orderItems.pop();
      renderOrderTable();
    }
  });

  // 清空订单
  document.getElementById('btnClearOrder').addEventListener('click', function () {
    orderItems = [];
    renderOrderTable();
  });

  // 顾客联 HTML
  function buildCustomerReceipt() {
    if (orderItems.length === 0) return '';
    var total = 0;
    var rows = orderItems.map(function (item) {
      var sub = item.price * item.qty;
      total += sub;
      return (
        '<tr>' +
          '<td class="num">' + item.code + '</td>' +
          '<td class="name-nl">' + item.nameNl + '</td>' +
          '<td class="price">' + formatMoney(item.price) + '</td>' +
          '<td class="qty">' + item.qty + '</td>' +
          '<td class="subtotal">' + formatMoney(sub) + '</td>' +
        '</tr>'
      );
    }).join('');

    return (
      '<h3>=== 顾客联 Customer ===</h3>' +
      '<table>' +
        '<thead>' +
          '<tr>' +
            '<th class="num">编号</th>' +
            '<th class="name-nl">菜名 (NL)</th>' +
            '<th class="price">单价</th>' +
            '<th class="qty">数量</th>' +
            '<th class="subtotal">小计</th>' +
          '</tr>' +
        '</thead>' +
        '<tbody>' + rows + '</tbody>' +
      '</table>' +
      '<div class="total-line">Total：€ ' + formatMoney(total) + '</div>'
    );
  }

  // 厨房联 HTML（每个菜只出现一次中文名）
  function buildKitchenReceipt() {
    if (orderItems.length === 0) return '';

    var lines = orderItems.map(function (item) {
      return (
        '<div class="kitchen-item">' +
          item.qty + '× ' + item.nameCn +
          '<br><small>(' + item.code + ')</small>' +
        '</div>'
      );
    }).join('');

    return '<h3>=== 厨房联 ===</h3>' + lines;
  }

  function makeReceipts(opts) {
    var showCustomer = !!opts.customer;
    var showKitchen = !!opts.kitchen;

    var cDiv = document.getElementById('customerReceipt');
    var kDiv = document.getElementById('kitchenReceipt');

    cDiv.innerHTML = showCustomer ? buildCustomerReceipt() : '';
    kDiv.innerHTML = showKitchen ? buildKitchenReceipt() : '';
  }

  document.getElementById('btnMakeBoth').addEventListener('click', function () {
    makeReceipts({ customer: true, kitchen: true });
  });

  document.getElementById('btnMakeCustomer').addEventListener('click', function () {
    makeReceipts({ customer: true, kitchen: false });
  });

  document.getElementById('btnMakeKitchen').addEventListener('click', function () {
    makeReceipts({ customer: false, kitchen: true });
  });

  // 默认示例菜单：31 古老鸡 / 65 鸡面
  document.getElementById('menuInput').value =
    '31,古老鸡,kip zoetzure,11.50\n' +
    '65,鸡面,bami kip,11.80';
  document.getElementById('btnImportMenu').click();
</script>
</body>
</html>
