<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>Corner City Gent 点单打印</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
                   "Helvetica Neue", Arial, "Microsoft YaHei", sans-serif;
      margin: 8px;
      font-size: 15px;
    }
    h1 {
      font-size: 22px;
      margin: 4px 0 8px;
    }
    h2 {
      font-size: 18px;
      margin: 10px 0 6px;
    }
    .section {
      border: 1px solid #ccc;
      padding: 8px;
      margin-bottom: 10px;
      border-radius: 4px;
    }
    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
      margin-bottom: 6px;
    }
    label {
      font-size: 14px;
    }
    input[type="text"],
    input[type="number"] {
      font-size: 15px;
      padding: 4px 6px;
      width: 90px;
      box-sizing: border-box;
    }
    textarea {
      width: 100%;
      min-height: 90px;
      font-size: 14px;
      padding: 4px;
      box-sizing: border-box;
      font-family: "Courier New", monospace;
      white-space: pre;
    }
    button {
      padding: 6px 10px;
      font-size: 14px;
      border-radius: 4px;
      border: 1px solid #333;
      background: #1976d2;
      color: #fff;
    }
    button.secondary {
      background: #555;
    }
    button.danger {
      background: #c62828;
    }
    button:active {
      opacity: 0.75;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
      margin-top: 4px;
    }
    th, td {
      padding: 3px 2px;
      border-bottom: 1px dashed #aaa;
    }
    th {
      text-align: left;
      font-weight: bold;
      background: #f5f5f5;
    }
    td.num {
      text-align: right;
      white-space: nowrap;
    }
    td.center {
      text-align: center;
      white-space: nowrap;
    }
    .total-line {
      text-align: right;
      font-weight: bold;
      margin-top: 4px;
      font-size: 14px;
    }
    .hint {
      font-size: 12px;
      color: #666;
      margin-top: 3px;
      line-height: 1.4;
    }
    #print-area {
      margin-top: 8px;
      border-top: 1px solid #000;
      padding-top: 6px;
    }
    .copy-block {
      margin-bottom: 12px;
    }
    .copy-title {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 4px;
    }
    .cut-line {
      text-align: center;
      font-size: 11px;
      margin: 6px 0;
    }
    .customer-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }
    .customer-table th,
    .customer-table td {
      border-bottom: 1px dashed #555;
      padding: 3px 2px;
    }
    .customer-table .num {
      text-align: right;
      white-space: nowrap;
    }
    .customer-total {
      text-align: right;
      font-weight: bold;
      font-size: 16px;
      margin-top: 4px;
    }
    .kitchen-title {
      font-size: 24px;
      font-weight: bold;
      margin-bottom: 6px;
    }
    .kitchen-item {
      font-size: 40px; /* 非常大：大约是普通字号的 5 倍视觉效果 */
      font-weight: bold;
      line-height: 1.3;
      margin: 4px 0;
    }
    .kitchen-item small {
      font-size: 18px;
      font-weight: normal;
      margin-left: 4px;
    }
    @media print {
      body {
        margin: 0;
        padding: 0 4px;
        font-size: 14px;
      }
      .section {
        display: none !important;
      }
      h1 {
        margin-top: 4px;
      }
    }
  </style>
</head>
<body>
  <h1>Corner City Gent 点单打印</h1>

  <div class="section">
    <h2>1. 菜单来源（示例 + 从 Excel 导出 CSV 粘贴）</h2>
    <div class="hint">
      默认内置示例菜品：<b>31 古老鸡 / 65 鸡面</b>。<br>
      如果你有 Excel 菜单：请从 Excel 另存为 CSV，然后复制内容粘贴到下面（每行：编号,中文名,荷兰语名,单价）。
    </div>
    <textarea id="csv-input" placeholder="例如：
31,古老鸡,kip zoetzure,11.50
65,鸡面,bami kip,11.80"></textarea>
    <div class="row">
      <button onclick="importMenu()">导入 / 覆盖菜单</button>
    </div>
  </div>

  <div class="section">
    <h2>2. 按编号加菜</h2>
    <div class="row">
      <label>编号：</label><input id="code-input" type="number" inputmode="numeric" />
      <label>份数：</label><input id="qty-input" type="number" inputmode="numeric" value="1" />
      <button class="secondary" onclick="addByCode()">按编号加入</button>
    </div>
    <div id="error-msg" class="hint" style="color:#c00;"></div>
  </div>

  <div class="section">
    <h2>3. 当前订单</h2>
    <div id="order-view"></div>
    <div class="row">
      <button class="secondary" onclick="removeLast()">删除最后一项</button>
      <button class="danger" onclick="clearOrder()">清空订单</button>
    </div>
  </div>

  <div class="section">
    <h2>4. 生成打印内容</h2>
    <div class="row">
      <button onclick="preparePrint('both')">打印两联（顾客联 + 厨房联）</button>
    </div>
    <div class="row">
      <button class="secondary" onclick="preparePrint('customer')">只打印顾客联</button>
      <button class="secondary" onclick="preparePrint('kitchen')">只打印厨房联</button>
    </div>
    <div class="hint">
      生成后，页面下方会出现顾客联 / 厨房联内容。<br>
      在 RawBT 的浏览器中打开本页面后，点击右上角打印图标即可打印。<br>
      如果希望顾客联和厨房联是两张纸：先选择“只打印顾客联”打印一次，再选择“只打印厨房联”打印一次。
    </div>
  </div>

  <div id="print-area"></div>

<script>
  // ===== 菜单数据：默认两道菜 =====
  var menu = {
    "31": { code: "31", cn: "古老鸡", nl: "kip zoetzure", price: 11.50 },
    "65": { code: "65", cn: "鸡面", nl: "bami kip", price: 11.80 }
  };

  // 当前订单：[{code, qty}]
  var order = [];

  function renderOrder() {
    var view = document.getElementById('order-view');
    if (order.length === 0) {
      view.innerHTML = '<div class="hint">当前订单为空，请先按编号加入菜品。</div>';
      return;
    }
    var html = '<table><thead><tr>' +
      '<th>编号</th><th>中文名</th><th>荷兰语名</th>' +
      '<th class="num">单价 (€)</th><th class="num">数量</th>' +
      '<th class="num">小计 (€)</th><th class="center">操作</th>' +
      '</tr></thead><tbody>';

    var total = 0;
    for (var i = 0; i < order.length; i++) {
      var item = order[i];
      var m = menu[item.code];
      if (!m) continue;
      var line = m.price * item.qty;
      total += line;
      html += '<tr>' +
        '<td>' + m.code + '</td>' +
        '<td>' + m.cn + '</td>' +
        '<td>' + m.nl + '</td>' +
        '<td class="num">' + m.price.toFixed(2) + '</td>' +
        '<td class="num">' + item.qty + '</td>' +
        '<td class="num">' + line.toFixed(2) + '</td>' +
        '<td class="center"><button onclick="removeIndex(' + i + ')">删</button></td>' +
        '</tr>';
    }
    html += '</tbody></table>';
    html += '<div class="total-line">合计：€ ' + total.toFixed(2) + '</div>';
    view.innerHTML = html;
  }

  function addByCode() {
    var codeInput = document.getElementById('code-input');
    var qtyInput = document.getElementById('qty-input');
    var err = document.getElementById('error-msg');
    err.textContent = '';

    var code = String(codeInput.value || '').trim();
    var qty = parseInt(qtyInput.value, 10);

    if (!code) {
      err.textContent = '请输入菜品编号。';
      return;
    }
    if (!menu[code]) {
      err.textContent = '编号 ' + code + ' 不在菜单中。';
      return;
    }
    if (!qty || qty <= 0) {
      err.textContent = '份数必须大于 0。';
      return;
    }

    order.push({ code: code, qty: qty });
    renderOrder();

    qtyInput.value = '1';
    codeInput.value = '';
    codeInput.focus();
  }

  function removeIndex(i) {
    order.splice(i, 1);
    renderOrder();
  }

  function removeLast() {
    if (order.length === 0) return;
    order.pop();
    renderOrder();
  }

  function clearOrder() {
    if (order.length === 0) return;
    if (!confirm('确定要清空本次订单吗？')) return;
    order = [];
    renderOrder();
    document.getElementById('print-area').innerHTML = '';
  }

  function importMenu() {
    var text = document.getElementById('csv-input').value;
    if (!text.trim()) {
      alert('文本框为空，将继续使用当前菜单。');
      return;
    }
    var lines = text.split(/\r?\n/);
    var newMenu = {};
    var count = 0;
    for (var i = 0; i < lines.length; i++) {
      var line = lines[i].trim();
      if (!line) continue;
      var parts = line.split(',');
      if (parts.length < 4) continue;
      var code = parts[0].trim();
      var cn = parts[1].trim();
      var nl = parts[2].trim();
      var price = parseFloat(parts[3].trim().replace(',', '.'));
      if (!code || !cn || !nl || isNaN(price)) continue;
      newMenu[code] = { code: code, cn: cn, nl: nl, price: price };
      count++;
    }
    if (count === 0) {
      alert('未能解析任何菜单项，请检查格式：编号,中文名,荷兰语名,单价');
      return;
    }
    menu = newMenu;
    order = [];
    renderOrder();
    alert('菜单导入成功，共 ' + count + ' 项。当前订单已清空。');
  }

  function preparePrint(mode) {
    if (order.length === 0) {
      alert('当前订单为空，请先加菜。');
      return;
    }
    var printArea = document.getElementById('print-area');

    // 合并相同编号
    var merged = {};
    for (var i = 0; i < order.length; i++) {
      var it = order[i];
      if (!merged[it.code]) merged[it.code] = { code: it.code, qty: 0 };
      merged[it.code].qty += it.qty;
    }
    var items = [];
    for (var k in merged) {
      if (merged.hasOwnProperty(k)) items.push(merged[k]);
    }

    var customerHTML = '';
    var kitchenHTML = '';

    if (mode === 'both' || mode === 'customer') {
      var sum = 0;
      customerHTML += '<div class="copy-block">' +
        '<div class="copy-title">=== 顾客联 Customer ===</div>' +
        '<table class="customer-table"><thead><tr>' +
        '<th>编号</th><th>菜名 (NL)</th>' +
        '<th class="num">单价</th><th class="num">数量</th>' +
        '<th class="num">小计</th>' +
        '</tr></thead><tbody>';

      for (var j = 0; j < items.length; j++) {
        var it = items[j];
        var m = menu[it.code];
        if (!m) continue;
        var line = m.price * it.qty;
        sum += line;
        customerHTML += '<tr>' +
          '<td>' + m.code + '</td>' +
          '<td>' + m.nl + '</td>' +
          '<td class="num">€ ' + m.price.toFixed(2) + '</td>' +
          '<td class="num">' + it.qty + '</td>' +
          '<td class="num">€ ' + line.toFixed(2) + '</td>' +
          '</tr>';
      }
      customerHTML += '</tbody></table>' +
        '<div class="customer-total">Total: € ' + sum.toFixed(2) + '</div>' +
        '</div>';
    }

    if (mode === 'both' || mode === 'kitchen') {
      kitchenHTML += '<div class="copy-block">' +
        '<div class="kitchen-title">=== 厨房联 ===</div>';
      for (var t = 0; t < items.length; t++) {
        var kt = items[t];
        var mk = menu[kt.code];
        if (!mk) continue;
        kitchenHTML += '<div class="kitchen-item">' +
          kt.qty + '×' + mk.cn +
          '</div>';
      }
      kitchenHTML += '</div>';
    }

    var finalHTML = '';
    if (mode === 'both') {
      finalHTML = customerHTML +
        '<div class="cut-line">----- 撕开分为 顾客联 / 厨房联 -----</div>' +
        kitchenHTML;
    } else if (mode === 'customer') {
      finalHTML = customerHTML;
    } else {
      finalHTML = kitchenHTML;
    }

    printArea.innerHTML = finalHTML;

    if (mode === 'both') {
      alert('已生成顾客联 + 厨房联内容，请点击 RawBT 的打印按钮打印。');
    } else if (mode === 'customer') {
      alert('已生成“顾客联”，建议单独打印一张。');
    } else {
      alert('已生成“厨房联”，建议单独打印一张。');
    }
  }

  // 初始化
  renderOrder();
</script>
</body>
</html>
